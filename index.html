<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Vendas VTS ‚Äî Etiquetas & Devolu√ß√µes</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='28' height='28' x='2' y='2' rx='6' ry='6' fill='%23f97316'/%3E%3Ctext x='16' y='22' font-size='16' text-anchor='middle' fill='white'%3Eüì¶%3C/text%3E%3C/svg%3E" />
  <!-- Firebase v10 modular -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore,
      initializeFirestore,
      collection,
      addDoc,
      setDoc,
      getDocs,
      getDoc,
      doc,
      query,
      where,
      orderBy,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // Config fornecida pelo usu√°rio
    const firebaseConfig = {
      apiKey: "AIzaSyDWok2hM9-HWITlLuqmYhGgEx8giXRUSTA",
      authDomain: "vtscontrole.firebaseapp.com",
      projectId: "vtscontrole",
      storageBucket: "vtscontrole.firebasestorage.app",
      messagingSenderId: "538434942205",
      appId: "1:538434942205:web:c174a1e336e5b75628fa94"
    };

    const app = initializeApp(firebaseConfig);

    // Alguns ambientes corporativos/ISP bloqueiam o protocolo WebChannel usado
    // pelo Firestore, resultando em erros 400 na stream "Write". For√ßamos o
    // uso do long polling e fazemos fallback para a inicializa√ß√£o padr√£o caso
    // o m√©todo n√£o esteja dispon√≠vel.
    let db;
    try {
      db = initializeFirestore(app, {
        experimentalForceLongPolling: true,
        useFetchStreams: false,
      });
    } catch (err) {
      console.warn("Falha ao for√ßar long polling, usando getFirestore padr√£o", err);
      db = getFirestore(app);
    }

    // Expor globalmente para app.js
    window.__vts = { db, collection, addDoc, setDoc, getDocs, getDoc, doc, query, where, orderBy, serverTimestamp };
  </script>

  <!-- Tesseract.js para OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
  <!-- pdf.js para renderizar PDFs em canvas e extrair imagens para o OCR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    // Config do pdf.js (worker)
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
    }
  </script>
</head>
<body>
  <header class="app-header">
    <h1>üì¶ Controle de Vendas VTS</h1>
    <nav class="tabs">
      <button class="tab active" data-tab="importar">Importar Etiquetas</button>
      <button class="tab" data-tab="salvos">Pedidos Salvos</button>
      <button class="tab" data-tab="devolucoes">Devolu√ß√µes</button>
    </nav>
  </header>

  <main>
    <!-- TAB: Importar Etiquetas -->
    <section id="tab-importar" class="tab-panel active">
      <div class="card">
        <h2>1) Selecione a origem</h2>
        <div class="grid">
          <label>Nome da Loja/Plataforma
            <input id="inpLoja" type="text" placeholder="Ex.: Shopee / Mercado Livre / Matheus" />
          </label>
          <label>Data da Venda (se souber)
            <input id="inpData" type="date" />
          </label>
        </div>
      </div>

      <div class="card">
        <h2>2) Envie a etiqueta</h2>
        <p>Voc√™ pode usar a c√¢mera (celular), subir uma imagem/PDF ou digitar manualmente.</p>
        <div class="grid">
          <label>üì∏ C√¢mera / Imagem
            <input id="inpImagem" type="file" accept="image/*" capture="environment" />
          </label>
          <label>üìÑ PDF (uma ou v√°rias p√°ginas)
            <input id="inpPdf" type="file" accept="application/pdf" />
          </label>
        </div>
        <details>
          <summary>‚úçÔ∏è Inser√ß√£o manual (colar texto capturado)</summary>
          <textarea id="inpTexto" rows="4" placeholder="Cole aqui o texto da etiqueta..."></textarea>
          <button id="btnProcessarTexto" class="btn">Processar texto</button>
        </details>
      </div>

      <div class="card">
        <h2>3) Pr√©-visualiza√ß√£o e corre√ß√£o</h2>
        <div id="previewImgs" class="preview"></div>
        <div class="grid">
          <label>SKU
            <input id="outSku" type="text" placeholder="Ex.: T6, T6+P4+A11, P1-ROSA" />
          </label>
          <label>N¬∫ de Rastreamento
            <input id="outRastreio" type="text" placeholder="Ex.: BR255041302814F" />
          </label>
          <label>ID da Venda / Pedido
            <input id="outVendaId" type="text" placeholder="Ex.: 25100235W20NP1 / Pack ID" />
          </label>
          <label>Loja / Plataforma
            <input id="outLoja" type="text" placeholder="Ex.: Matheus / Casa Rosa / Shopee" />
          </label>
          <label>Data (DD/MM/AAAA)
            <input id="outData" type="text" placeholder="Ex.: 02/10/2025" />
          </label>
        </div>
        <button id="btnSalvar" class="btn primary">üíæ Salvar no Firebase</button>
        <div id="saveMsg"></div>
        <details>
          <summary>üßæ Texto completo lido (OCR)</summary>
          <pre id="ocrDump"></pre>
        </details>
      </div>
    </section>

    <!-- TAB: Pedidos Salvos -->
    <section id="tab-salvos" class="tab-panel">
      <div class="card">
        <h2>Pedidos (√∫ltimos 500)</h2>
        <div class="grid">
          <input id="filtroBusca" type="search" placeholder="Filtrar por SKU, rastreio, vendaId ou loja..." />
          <button id="btnRecarregar" class="btn">Recarregar</button>
          <button id="btnExportar" class="btn">Exportar CSV</button>
        </div>
        <div class="table-wrap">
          <table id="tblPedidos">
            <thead>
              <tr>
                <th>Data</th>
                <th>SKU</th>
                <th>Rastreio</th>
                <th>Venda ID</th>
                <th>Loja</th>
                <th>Devolvido?</th>
                <th>Salvo em</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- TAB: Devolu√ß√µes -->
    <section id="tab-devolucoes" class="tab-panel">
      <div class="card">
        <h2>Marcar pedido como devolvido</h2>
        <p>Informe o <b>n¬∫ de rastreio</b> ou o <b>ID do pedido</b>. O sistema vai buscar e marcar como devolvido.</p>
        <div class="grid">
          <label>Rastreio
            <input id="devRastreio" type="text" placeholder="Ex.: BR255041302814F" />
          </label>
          <label>Venda ID
            <input id="devVendaId" type="text" placeholder="Ex.: 25100235W20NP1" />
          </label>
        </div>
        <button id="btnMarcarDevolvido" class="btn danger">üö© Marcar devolvido</button>
        <div id="devMsg"></div>
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <small>Feito para leitura de etiquetas reais (OCR) ‚Äî suporta imagem e PDF ‚Äî salva no Firestore.</small>
  </footer>

  <script type="module" src="app.js"></script>
</body>
</html>
